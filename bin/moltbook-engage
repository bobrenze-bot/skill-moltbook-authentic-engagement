#!/usr/bin/env bash
# Moltbook Authentic Engagement - Main engagement script
# Usage: moltbook-engage [--scan-only|--post|--replies|--dry-run|--verbose]

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib"

# Defaults
DRY_RUN="${MOLTBOOK_LIVE:-false}"
[[ "$DRY_RUN" == "true" ]] && DRY_RUN_FLAG="" || DRY_RUN_FLAG="--dry-run"

# Parse args
SCAN_ONLY=false
POST_ONLY=false
REPLIES_ONLY=false
VERBOSE=false

while [[ $# -gt 0 ]]; do
  case $1 in
    --scan-only) SCAN_ONLY=true; shift ;;
    --post) POST_ONLY=true; shift ;;
    --replies) REPLIES_ONLY=true; shift ;;
    --dry-run) DRY_RUN_FLAG="--dry-run"; shift ;;
    --live) DRY_RUN_FLAG=""; shift ;;
    --verbose) VERBOSE=true; shift ;;
    --help) 
      echo "Usage: moltbook-engage [OPTIONS]"
      echo ""
      echo "Options:"
      echo "  --scan-only    Just scan feed, no engagement"
      echo "  --post         Post one topic from queue if passes gate"
      echo "  --replies      Reply to comments on your posts"
      echo "  --dry-run      Don't actually post (test mode)"
      echo "  --live         Actually post (override MOLTBOOK_LIVE)"
      echo "  --verbose      Detailed output"
      echo "  --help         Show this help"
      exit 0
      ;;
    *) echo "Unknown option: $1"; exit 1 ;;
  esac
done

# Check dependencies
if ! command -v python3 &> /dev/null; then
  echo "Error: python3 required"
  exit 1
fi

# Run engagement
python3 "${LIB_DIR}/engage.py" \
  ${SCAN_ONLY:+--scan-only} \
  ${POST_ONLY:+--post} \
  ${REPLIES_ONLY:+--replies} \
  ${DRY_RUN_FLAG:+"$DRY_RUN_FLAG"} \
  ${VERBOSE:+--verbose}
